<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Get Transcript</title>
    <link rel="stylesheet" href="styles.css">
    <!-- Vidstack Player CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/vidstack/styles/defaults.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/vidstack/styles/community-skin/video.css">
</head>
<body>
    <div class="container">
        <header>
            <h1>Parasocial Workbench</h1>
            <nav>
                <ul>
                    <li><a href="index.html">Transcription Details</a></li>
                    <li><a href="transcript.html" class="active">Get Transcript</a></li>
                    <li><a href="vod-diary.html">Vod Diary</a></li>
                </ul>
            </nav>
        </header>

        <main>
            <div class="video-section">
                <div class="video-selector">
                    <div class="video-selector-row">
                        <div class="video-input-container">
                            <input type="text" class="video-input" list="video-options" placeholder="Enter arichive.wubby.tv URL or select from dropdown">
                        </div>
                        <datalist id="video-options">
                            <option value="https://archive.wubby.tv/vods/public/jul_2025/2_LITTLE%20PEOPLE%20BIG%20DESSERT%20-%20POOKIE%20RESPONDS%20-%20JEWISH%20WEDDINGS%20-%20PENCIL%20SHARPENER%20GUY%20ON%20CALL%20-%20UNDER%20THE%20SEAT%20VIBES_1751499060_000.mp4">Little People Big Dessert</option>
                         </datalist>
                        <button class="btn green-btn">Load</button>
                        <button class="btn clear-btn">Clear</button>
                    </div>
                    <div class="hash-display">
                        <code class="hash-value">Hash: <span id="current-hash">-</span></code>
                        <code class="status-value">Status: <span id="current-status">-</span></code>
                    </div>
                </div>
                
                <div class="video-player">
                    <div class="player-controls">
                    </div>
                    
                    <div class="video-container">
                        <!-- Vidstack Player -->
                        <media-player
                            class="video-player-box"
                            src="https://files.vidstack.io/sprite-fight/720p.mp4"
                            poster="https://files.vidstack.io/sprite-fight/poster.webp"
                            playsinline
                        >
                            <media-outlet>
                                <track
                                    id="subtitle-track"
                                    src=""
                                    kind="subtitles"
                                    srclang="en"
                                    label="English"
                                    default
                                >
                            </media-outlet>
                            <media-community-skin></media-community-skin>
                        </media-player>
                    </div>
                    
                    <div class="video-info">
                        <h4 class="video-title">Sprite Fight</h4>
                        <h3>YouTube Video - Vidstack Player</h3>
                        <div class="tags-container">
                            <span class="tag">youtube</span>
                            <span class="tag">vidstack</span>
                            <span class="tag">transcript</span>
                        </div>
                        <div class="summary-box">
                            <p class="summary">Transcript testing page using Vidstack player. Features play button, settings menu, and CC button for English subtitles and Supabase VTT. Use CC button to switch to "Supabase Test" for transcript extraction testing.</p>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Vidstack Player JS -->
    <script type="module" src="https://cdn.jsdelivr.net/npm/vidstack/dist/cdn/prod.js"></script>
    <script type="module">
        console.log('=== VIDSTACK ENHANCEMENT SCRIPT (v4) ===');
        
        customElements.whenDefined('media-player').then(() => {
            console.log('‚úÖ `media-player` element is defined.');
            const player = document.querySelector('media-player');

            if (player) {
                console.log('‚úÖ Player element found in DOM:', player);

                player.addEventListener('error', (event) => {
                    console.error('‚ùå Player error:', event.detail);
                });
            } else {
                console.error('‚ùå Player element not found in DOM after definition.');
            }
        }).catch(err => {
            console.error('‚ùå Error waiting for `media-player` definition:', err);
        });
    </script>
    <script src="script.js"></script>
    <script type="module">
        /* ===========================================
           Dynamic Subtitle Loader - Supabase (v1)
           =========================================== */
        console.log("=== SUBTITLE LOADER SCRIPT START ===");

        // DOM references
        const loadBtn = document.querySelector('.green-btn');
        const videoInputEl = document.querySelector('.video-input');
        const subtitleTrackEl = document.getElementById('subtitle-track');

        if (!loadBtn) {
            console.error('[SubtitleLoader] ‚ùå Load button not found.');
        }
        if (!videoInputEl) {
            console.error('[SubtitleLoader] ‚ùå Video input element not found.');
        }
        if (!subtitleTrackEl) {
            console.error('[SubtitleLoader] ‚ùå Subtitle <track> element not found.');
        }

        // Helper: compute SHA-256 hash, same logic as script.js
        // This function takes a string (the video URL) and returns its SHA-256 hash in hex format.
        // We use this hash to uniquely identify each video and organize subtitle files in Supabase storage.
        async function computeSHA256Hex(str) {
            const encoder = new TextEncoder();
            const data = encoder.encode(str);
            const hashBuffer = await crypto.subtle.digest('SHA-256', data);
            const hashArray = Array.from(new Uint8Array(hashBuffer));
            return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
        }

        const SUPABASE_URL = 'https://sbvaclmypokafpxebusn.supabase.co'; // TODO: update if project URL changes

        async function handleLoadClick() {
            console.log('[SubtitleLoader] ‚ñ∂Ô∏è Load button clicked');
            const videoUrl = videoInputEl.value.trim();
            if (!videoUrl) {
                console.warn('[SubtitleLoader] ‚ö†Ô∏è No video URL entered, aborting subtitle load.');
                return;
            }

            // --- DYNAMIC SUBTITLE URL CONSTRUCTION ---
            // We compute the SHA-256 hash of the input video URL. This hash is used as a folder name in Supabase storage.
            // The resulting subtitle file path is:
            //   [bucket]/wubbytranscript/[SHA256_HASH_OF_VIDEO_URL]/en/subtitle.vtt
            // This ensures each video URL maps to a unique subtitle file, and allows for scalable, organized storage.
            console.log('[SubtitleLoader] üì∫ Video URL:', videoUrl);
            console.log('[SubtitleLoader] üîÑ Computing SHA-256 hash ‚Ä¶');
            const videoHash = await computeSHA256Hex(videoUrl);
            console.log('[SubtitleLoader] üè∑Ô∏è Computed hash:', videoHash);

            // Construct Supabase storage path for the subtitle file
            const subtitleSrc = `${SUPABASE_URL}/storage/v1/object/public/wubbytranscript/${videoHash}/en/subtitle.vtt`;
            console.log('[SubtitleLoader] üìÑ Subtitle source URL:', subtitleSrc);

            // Test if the subtitle file exists before setting it
            console.log('[SubtitleLoader] üîç Testing subtitle URL accessibility...');
            try {
                const testResponse = await fetch(subtitleSrc, { method: 'HEAD' });
                console.log('[SubtitleLoader] üìä Subtitle URL test response:', {
                    status: testResponse.status,
                    statusText: testResponse.statusText,
                    ok: testResponse.ok,
                    url: testResponse.url
                });
                
                if (!testResponse.ok) {
                    console.error('[SubtitleLoader] ‚ùå Subtitle file not accessible:', {
                        status: testResponse.status,
                        message: testResponse.statusText
                    });
                    return;
                }
                
                console.log('[SubtitleLoader] ‚úÖ Subtitle file is accessible');
            } catch (fetchError) {
                console.error('[SubtitleLoader] ‚ùå Network error testing subtitle URL:', fetchError);
                console.error('[SubtitleLoader] üîÑ Proceeding anyway - might be CORS-related...');
            }

            // Get reference to the media player
            const playerEl = document.querySelector('media-player');
            if (!playerEl) {
                console.error('[SubtitleLoader] ‚ùå Media player not found');
                return;
            }

            // --- DYNAMICALLY REPLACING THE PLAYER TO ADD SUBTITLE TRACK ---
            // Vidstack's <media-player> does not support changing <track> elements on the fly.
            // To update the subtitle track, we remove the old player and create a new one with the correct <track>.
            // This ensures the new subtitle file is loaded and selectable in the player UI.
            console.log('[SubtitleLoader] üîÑ Recreating media player with subtitle track...');
            
            // Get the video container
            const videoContainer = playerEl.parentElement;
            
            // Store current video attributes
            const currentPoster = playerEl.getAttribute('poster');
            const currentClass = playerEl.getAttribute('class');
            
            // Remove the old player
            playerEl.remove();
            
            // Create new media player with embedded track
            const newPlayer = document.createElement('media-player');
            newPlayer.setAttribute('class', currentClass);
            newPlayer.setAttribute('src', videoUrl); // Use the actual video URL from input
            newPlayer.setAttribute('poster', currentPoster);
            newPlayer.setAttribute('playsinline', '');
            
            // Create media-outlet
            const mediaOutlet = document.createElement('media-outlet');
            
            // Create and add the subtitle track
            // The <track> element is dynamically created and added to the new player, pointing to the computed subtitleSrc.
            // This allows the player to load the correct subtitles for the selected video URL.
            const trackEl = document.createElement('track');
            trackEl.id = 'subtitle-track';
            trackEl.src = subtitleSrc;
            trackEl.kind = 'subtitles';
            trackEl.srclang = 'en';
            trackEl.label = 'English';
            trackEl.default = true;
            
            // Add track to media-outlet
            mediaOutlet.appendChild(trackEl);
            
            // Create the skin
            const skin = document.createElement('media-community-skin');
            
            // Add outlet and skin to player
            newPlayer.appendChild(mediaOutlet);
            newPlayer.appendChild(skin);
            
            // Add new player to container
            videoContainer.appendChild(newPlayer);
            
            console.log('[SubtitleLoader] ‚úÖ Media player recreated with embedded subtitle track');
            console.log('[SubtitleLoader] üé¨ Loading actual video URL with subtitles');
            
            // Wait for the new player to initialize
            setTimeout(() => {
                console.log('[SubtitleLoader] üîÑ Checking new player for text tracks...');
                
                // Get reference to the new player
                const currentPlayer = document.querySelector('media-player');
                if (!currentPlayer) {
                    console.error('[SubtitleLoader] ‚ùå New player not found');
                    return;
                }
                
                // Check if text tracks are available
                if (currentPlayer.textTracks && currentPlayer.textTracks.length > 0) {
                    console.log('[SubtitleLoader] üì∫ Found text tracks:', currentPlayer.textTracks.length);
                    
                    // Enable all English tracks
                    for (let i = 0; i < currentPlayer.textTracks.length; i++) {
                        const track = currentPlayer.textTracks[i];
                        console.log(`[SubtitleLoader] üìã Track ${i}:`, {
                            kind: track.kind,
                            language: track.language,
                            label: track.label,
                            mode: track.mode
                        });
                        
                        if (track.language === 'en' || track.label === 'English') {
                            track.mode = 'showing';
                            console.log('[SubtitleLoader] ‚úÖ Enabled English subtitle track');
                        }
                    }
                } else {
                    console.warn('[SubtitleLoader] ‚ö†Ô∏è No text tracks found on new player');
                    
                    // Try to manually enable the track element
                    const trackElement = currentPlayer.querySelector('track');
                    if (trackElement) {
                        console.log('[SubtitleLoader] üîß Found track element, forcing load...');
                        trackElement.track.mode = 'showing';
                    }
                }
                
                console.log('[SubtitleLoader] ‚úÖ New player setup complete');
            }, 1000);
            
            // Listen for track events
            trackEl.addEventListener('load', () => {
                console.log('[SubtitleLoader] üéâ Subtitle track loaded successfully');
            });
            
            trackEl.addEventListener('error', (e) => {
                console.error('[SubtitleLoader] ‚ùå Subtitle track failed to load:', e);
            });
        }

        if (loadBtn) {
            loadBtn.addEventListener('click', handleLoadClick);
        }
    </script>
</body>
</html> 